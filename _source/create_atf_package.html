

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2. Create ATF package &mdash; training_atf  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="training_atf  documentation" href="../index.html"/>
        <link rel="next" title="3. Run ATF tests" href="run_atf_tests.html"/>
        <link rel="prev" title="1. Prepare workspace" href="prepare_workspace.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> training_atf
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="prepare_workspace.html">1. Prepare workspace</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2. Create ATF package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#download-atf-template">2.1. Download ATF template</a></li>
<li class="toctree-l2"><a class="reference internal" href="#launch-file">2.2. Launch file</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-application">2.3. Test application</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configurations">2.4. Configurations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#robots">2.4.1. Robots</a></li>
<li class="toctree-l3"><a class="reference internal" href="#robot-environments">2.4.2. Robot environments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tests">2.4.3. Tests</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="run_atf_tests.html">3. Run ATF tests</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">training_atf</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>2. Create ATF package</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/_source/create_atf_package.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This instruction was tested on <code class="docutils literal"><span class="pre">Ubuntu</span> <span class="pre">16.04</span></code> and <code class="docutils literal"><span class="pre">ROS</span> <span class="pre">Kinetic</span> <span class="pre">Kame</span></code>.</p>
</div>
<div class="section" id="create-atf-package">
<span id="create-atf-package"></span><h1>2. Create ATF package<a class="headerlink" href="#create-atf-package" title="Permalink to this headline">¶</a></h1>
<p>The current work-flow intend the developer to have a dedicated ROS package for the examined application.</p>
<div class="section" id="download-atf-template">
<span id="download-atf-template"></span><h2>2.1. Download ATF template<a class="headerlink" href="#download-atf-template" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/training_ws/src
git clone https://github.com/ipa-jfh/training_atf
</pre></div>
</div>
</div>
<div class="section" id="launch-file">
<span id="launch-file"></span><h2>2.2. Launch file<a class="headerlink" href="#launch-file" title="Permalink to this headline">¶</a></h2>
<p>There is one central application launch file which will be started by ATF.
It should contain all the rosnodes that are required to perform the test run. In this example we will need to run the Simulation and Navigation packages for Turtlebot3.
Besides, it must provide certain arguments which enable to start the test with the desired variations.</p>
<p>The following code represents the full launch script. Add it into the according <code class="docutils literal"><span class="pre">launch/application.launch</span></code> file of your ATF test package.</p>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;launch&gt;</span>
  <span class="nt">&lt;arg</span> <span class="na">name=</span><span class="s">&quot;robot&quot;</span> 		<span class="na">default=</span><span class="s">&quot;waffle&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;arg</span> <span class="na">name=</span><span class="s">&quot;x_pos&quot;</span> 		<span class="na">default=</span><span class="s">&quot;-2.0&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;arg</span> <span class="na">name=</span><span class="s">&quot;y_pos&quot;</span> 		<span class="na">default=</span><span class="s">&quot;-0.5&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;arg</span> <span class="na">name=</span><span class="s">&quot;z_pos&quot;</span> 		<span class="na">default=</span><span class="s">&quot;0.0&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;arg</span> <span class="na">name=</span><span class="s">&quot;map_file&quot;</span> 	<span class="na">default=</span><span class="s">&quot;$(find turtlebot3_atf)/map/map.yaml&quot;</span><span class="nt">/&gt;</span>

  <span class="c">&lt;!-- Start simulation of Turtlebot3 in turtlebot3_world --&gt;</span>
  <span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">&quot;tf&quot;</span> <span class="na">type=</span><span class="s">&quot;static_transform_publisher&quot;</span> <span class="na">name=</span><span class="s">&quot;camera_tf&quot;</span> <span class="na">args=</span><span class="s">&quot;-1.95 -0.55 2.0 -1.58 0 -1.58 /odom /camera_link 100&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;include</span> <span class="na">file=</span><span class="s">&quot;$(find gazebo_ros)/launch/empty_world.launch&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;arg</span> <span class="na">name=</span><span class="s">&quot;world_name&quot;</span> <span class="na">value=</span><span class="s">&quot;$(find turtlebot3_gazebo)/models/turtlebot3.world&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;arg</span> <span class="na">name=</span><span class="s">&quot;gui&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/include&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;robot_description&quot;</span> <span class="na">command=</span><span class="s">&quot;$(find xacro)/xacro.py $(find turtlebot3_description)/urdf/turtlebot3_$(arg robot).urdf.xacro&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;node</span> <span class="na">name=</span><span class="s">&quot;spawn_urdf&quot;</span> <span class="na">pkg=</span><span class="s">&quot;gazebo_ros&quot;</span> <span class="na">type=</span><span class="s">&quot;spawn_model&quot;</span> <span class="na">args=</span><span class="s">&quot;-urdf -model turtlebot3_burger -x $(arg x_pos) -y $(arg y_pos) -z $(arg z_pos) -param robot_description&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- Start navigation tools for Turtlebot3 and load specified map --&gt;</span>
  <span class="nt">&lt;include</span> <span class="na">file=</span><span class="s">&quot;$(find turtlebot3_bringup)/launch/turtlebot3_remote.launch&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;node</span> <span class="na">name=</span><span class="s">&quot;map_server&quot;</span> <span class="na">pkg=</span><span class="s">&quot;map_server&quot;</span> <span class="na">type=</span><span class="s">&quot;map_server&quot;</span> <span class="na">args=</span><span class="s">&quot;$(arg map_file)&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;include</span> <span class="na">file=</span><span class="s">&quot;$(find turtlebot3_navigation)/launch/amcl.launch.xml&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">&quot;move_base&quot;</span> <span class="na">type=</span><span class="s">&quot;move_base&quot;</span> <span class="na">respawn=</span><span class="s">&quot;false&quot;</span> <span class="na">name=</span><span class="s">&quot;move_base&quot;</span> <span class="na">output=</span><span class="s">&quot;screen&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;base_local_planner&quot;</span> <span class="na">value=</span><span class="s">&quot;dwa_local_planner/DWAPlannerROS&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;rosparam</span> <span class="na">file=</span><span class="s">&quot;$(find turtlebot3_navigation)/param/costmap_common_params_$(arg robot).yaml&quot;</span> <span class="na">command=</span><span class="s">&quot;load&quot;</span> <span class="na">ns=</span><span class="s">&quot;global_costmap&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;rosparam</span> <span class="na">file=</span><span class="s">&quot;$(find turtlebot3_navigation)/param/costmap_common_params_$(arg robot).yaml&quot;</span> <span class="na">command=</span><span class="s">&quot;load&quot;</span> <span class="na">ns=</span><span class="s">&quot;local_costmap&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;rosparam</span> <span class="na">file=</span><span class="s">&quot;$(find turtlebot3_navigation)/param/local_costmap_params.yaml&quot;</span> <span class="na">command=</span><span class="s">&quot;load&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;rosparam</span> <span class="na">file=</span><span class="s">&quot;$(find turtlebot3_navigation)/param/global_costmap_params.yaml&quot;</span> <span class="na">command=</span><span class="s">&quot;load&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;rosparam</span> <span class="na">file=</span><span class="s">&quot;$(find turtlebot3_navigation)/param/move_base_params.yaml&quot;</span> <span class="na">command=</span><span class="s">&quot;load&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;rosparam</span> <span class="na">file=</span><span class="s">&quot;$(find turtlebot3_navigation)/param/dwa_local_planner_params.yaml&quot;</span> <span class="na">command=</span><span class="s">&quot;load&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/node&gt;</span>

  <span class="c">&lt;!-- Set estimated starting position --&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;amcl/initial_pose_x&quot;</span> <span class="na">value=</span><span class="s">&quot;$(arg x_pos)&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;amcl/initial_pose_y&quot;</span> <span class="na">value=</span><span class="s">&quot;$(arg y_pos)&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;amcl/initial_pose_a&quot;</span> <span class="na">value=</span><span class="s">&quot;$(arg z_pos)&quot;</span><span class="nt">/&gt;</span>

  <span class="c">&lt;!-- Start configured rviz --&gt;</span>
  <span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">&quot;rviz&quot;</span> <span class="na">type=</span><span class="s">&quot;rviz&quot;</span> <span class="na">name=</span><span class="s">&quot;rviz&quot;</span> <span class="na">args=</span><span class="s">&quot;-d $(find turtlebot3_navigation)/rviz/turtlebot3_nav.rviz&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/launch&gt;</span>
</pre></div>
</td></tr></table></div>
<p>The next step is to create the actual test application node, which ATF will automatically include into the launch file.</p>
</div>
<div class="section" id="test-application">
<span id="test-application"></span><h2>2.3. Test application<a class="headerlink" href="#test-application" title="Permalink to this headline">¶</a></h2>
<p>This script contains the runtime of the test application and it will be automatically executed by ATF for every test case. If this program is finished it also terminates all the nodes that have been started and proceed to the next test. The general content of the file is the following. It creates an rosnode, containing the <em>Application</em> which is structured by an <em>init</em> and an <em>execute</em> function. These should be extended by the user to fit the needs of the test application. It provides two ways to run the node. Without any arguments it will perform a <em>ROS test</em> which will jump into the <em>Test</em> class (this should not be modified by the user). However, by using the <em>standalone</em> argument one could start it manually as a typical rosnode for debugging purpose.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">rostest</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">atf_core</span> <span class="kn">import</span> <span class="n">ATF</span>

<span class="k">class</span> <span class="nc">Application</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atf</span> <span class="o">=</span> <span class="n">ATF</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Insert your ATF test blocks here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atf</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;test_both1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atf</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;test_block1&quot;</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="c1"># Placeholder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atf</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;test_block1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atf</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;test_block2&quot;</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="c1"># Another placeholder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atf</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;test_block2&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atf</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;test_both1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atf</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Test</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">test_Recording</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s1">&#39;turtlebot3_atf&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;standalone&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">()</span>
        <span class="n">app</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rostest</span><span class="o">.</span><span class="n">rosrun</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;recording&#39;</span><span class="p">,</span> <span class="n">Test</span><span class="p">,</span> <span class="n">sysargs</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Add the following code after the existing imports (<em>l.8</em>) of <code class="docutils literal"><span class="pre">application.py</span></code>. They import the further necessary libraries regarding the ROS navigation and transformation stack.
Additionally, they cover two new functions that simply help to send a goal message to the ROS <em>MoveBaseAction</em>. The <code class="docutils literal"><span class="pre">move_base.wait_for_result()</span></code> line makes sure that the thread will wait for the action, in this case the movement, has finished.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">actionlib</span>
<span class="kn">from</span> <span class="nn">move_base_msgs.msg</span> <span class="kn">import</span> <span class="n">MoveBaseAction</span><span class="p">,</span> <span class="n">MoveBaseGoal</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">PoseWithCovarianceStamped</span><span class="p">,</span> <span class="n">Quaternion</span>
<span class="kn">from</span> <span class="nn">actionlib_msgs.msg</span> <span class="kn">import</span> <span class="n">GoalStatus</span>
<span class="kn">from</span> <span class="nn">tf.transformations</span> <span class="kn">import</span> <span class="n">quaternion_from_euler</span>

<span class="n">goal_param</span> <span class="o">=</span> <span class="s2">&quot;/atf/test_config/move_to_goal/preset_goal2d&quot;</span>

<span class="k">def</span> <span class="nf">create_nav_goal</span><span class="p">(</span><span class="n">goal_2d</span><span class="p">):</span>
    <span class="s2">&quot;Create a MoveBaseGoal with x, y (in m) and yaw (in deg).&quot;</span>

    <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">goal_2d</span><span class="p">))</span>
    <span class="n">goal</span> <span class="o">=</span> <span class="n">MoveBaseGoal</span><span class="p">()</span>
    <span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s1">&#39;/map&#39;</span>
    <span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">goal_2d</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
    <span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">goal_2d</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">quaternion_from_euler</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">goal_2d</span><span class="p">[</span><span class="s2">&quot;yaw&quot;</span><span class="p">])</span>
    <span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">Quaternion</span><span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">goal</span>

<span class="k">def</span> <span class="nf">move_to_goal</span><span class="p">(</span><span class="n">move_base</span><span class="p">,</span> <span class="n">goal</span><span class="p">):</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Send goal to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="p">)</span>
    <span class="n">move_base</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Waiting for result...&quot;</span><span class="p">)</span>
    <span class="n">move_base</span><span class="o">.</span><span class="n">wait_for_result</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">move_base</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span> <span class="o">==</span> <span class="n">GoalStatus</span><span class="o">.</span><span class="n">SUCCEEDED</span><span class="p">:</span> <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Reached goal!&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span> <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Goal not reached!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The next step is to structure the program and the evaluation. One can define certain sequences as <em>ATF test blocks</em> that can be examined regarding desired key performance indicators.
Therefore, it has to be embraced with <em>start</em> and a <em>stop</em> function call. In the provided test scenario we use only one block for the navigation task.
Finally, there is one more function which triggers the shutdown.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">It is also possible to have multiple <em>ATF test blocks</em>, even nested ones.</p>
</div>
<p>Add the following lines to the end of the <em>init</em> function (<em>l.12</em>) to initialize the action client:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">move_base</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span><span class="s1">&#39;/move_base&#39;</span><span class="p">,</span> <span class="n">MoveBaseAction</span><span class="p">)</span>
<span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Connecting to /move_base action&quot;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">move_base</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>
</pre></div>
</div>
<p>Replace the content of the <em>execute</em> function (<em>l.14-26</em>) with the following lines:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">atf</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;move_to_goal&quot;</span><span class="p">)</span>
<span class="c1"># Send move_base goal to robot</span>
<span class="n">move_to_goal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_base</span><span class="p">,</span> <span class="n">create_nav_goal</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">goal_param</span><span class="p">)))</span>
<span class="bp">self</span><span class="o">.</span><span class="n">atf</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;move_to_goal&quot;</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">atf</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="configurations">
<span id="configurations"></span><h2>2.4. Configurations<a class="headerlink" href="#configurations" title="Permalink to this headline">¶</a></h2>
<p>ROS application typically consists of a multitude of components and application variations. ATF assists the developer to test all variations automatically.
The ATF tool distinguishes therefore between three different sources:</p>
<ul class="simple">
<li>robots</li>
<li>robot_envs</li>
<li>test_configs</li>
</ul>
<p>One example is to evaluate different type of robots. One can also examine different robot configurations of the same model e.g. by tuning parameters of the motion configuration. Moreover, there is the possibility to simulate the robot in different worlds, which leads to a set of test environments. One more set of variation is related to the examined performance indicators, which is denoted as test_configs.</p>
<p>With <code class="docutils literal"><span class="pre">config/test_suites.yaml</span></code> the user can specify which constellations of variations are of interest and generate a matrix of test suites.</p>
<p>The number of test will be: n<sub>tests</sub> = n<sub>robots</sub> x n<sub>robot_envs</sub> x n<sub>test_configs</sub></p>
<p>Change its content for this example to the following:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># Definition of various test suites</span>
<span class="l l-Scalar l-Scalar-Plain">testsuite_1</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">test_configs</span><span class="p p-Indicator">:</span>                 <span class="c1"># You have to define at least one test_config</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">test1</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">test2</span>
  <span class="l l-Scalar l-Scalar-Plain">robots</span><span class="p p-Indicator">:</span>                       <span class="c1"># You have to define at least one robot</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">burger</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">waffle</span>
  <span class="l l-Scalar l-Scalar-Plain">robot_envs</span><span class="p p-Indicator">:</span>                   <span class="c1"># You have to define at least one robot_env</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">env1</span>
</pre></div>
</div>
<p>Further configurations of the ATF package can be done in the <code class="docutils literal"><span class="pre">config/test_generation_config.yaml</span></code> file. As what concerns this training one does not need to change anything. There is e.g. the option to define a certain number of repetitions, in order to eliminate stochastic uncertainty.</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">suites_file</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">config/test_suites.yaml</span>                       <span class="c1"># Path of the test_suite file</span>
<span class="l l-Scalar l-Scalar-Plain">test_config_path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">config/test_configs</span>                      <span class="c1"># Path of the test_config file</span>
<span class="l l-Scalar l-Scalar-Plain">robot_config_path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">config/robots</span>                           <span class="c1"># Folder which contains the robot_config files</span>
<span class="l l-Scalar l-Scalar-Plain">robot_env_config_path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">config/robot_envs</span>                   <span class="c1"># Folder which contains the robot_env_config files</span>
<span class="l l-Scalar l-Scalar-Plain">repetitions</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>                                             <span class="c1"># Number of repetitions per test</span>

<span class="l l-Scalar l-Scalar-Plain">app_executable</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">application.py</span>                             <span class="c1"># Name of the application&#39;s executable file</span>
<span class="l l-Scalar l-Scalar-Plain">additional_launch_file</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">launch/application.launch</span>          <span class="c1"># Path of the additional launch file</span>

<span class="l l-Scalar l-Scalar-Plain">bagfile_output</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/turtlebot3_atf/data/</span>                  <span class="c1"># Folder for bagfile output</span>
<span class="l l-Scalar l-Scalar-Plain">json_output</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/turtlebot3_atf/results_json/</span>             <span class="c1"># Folder for the json files output</span>
<span class="l l-Scalar l-Scalar-Plain">yaml_output</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/turtlebot3_atf/results_yaml/</span>             <span class="c1"># Folder for the yaml files output</span>

<span class="l l-Scalar l-Scalar-Plain">speed_factor_analysis</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10.0</span>                                <span class="c1"># Factor to speedup analysis (can lower accuracy if to fast, especially path_length)</span>

<span class="l l-Scalar l-Scalar-Plain">time_limit_recording</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">60.0</span>                                 <span class="c1"># Time limit in seconds for recording</span>
<span class="l l-Scalar l-Scalar-Plain">time_limit_analysing</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">20.0</span>                                 <span class="c1"># Time limit in seconds for analysing</span>
<span class="l l-Scalar l-Scalar-Plain">time_limit_uploading</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">60.0</span>                                 <span class="c1"># Time limit in seconds for uploading</span>

<span class="l l-Scalar l-Scalar-Plain">upload_data</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="l l-Scalar l-Scalar-Plain">upload_result</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="robots">
<span id="robots"></span><h3>2.4.1. Robots<a class="headerlink" href="#robots" title="Permalink to this headline">¶</a></h3>
<p>For this training we want to use the <em>Turtlebot3</em> robot. It comes with two variations, one is called <em>Waffle</em> and one <em>Burger</em>. In order to run the tests with both robots we need to add the following files into the <code class="docutils literal"><span class="pre">config/robots</span></code> folder.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">burger.yaml</span></code></li>
</ul>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">path_length</span><span class="p p-Indicator">:</span>                                          <span class="c1"># Topics for the metric &#39;path_length&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">topics</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;/tf&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">wait_for_topics</span><span class="p p-Indicator">:</span>                                      <span class="c1"># Names of the topics to wait for before beginning the test</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;/odom&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">wait_for_services</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span>                                 <span class="c1"># Names of the services to wait for before beginning the test</span>
<span class="l l-Scalar l-Scalar-Plain">additional_parameters</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span>                             <span class="c1"># Name and value of additional parameter which will be included in every recording test file</span>
<span class="l l-Scalar l-Scalar-Plain">additional_arguments</span><span class="p p-Indicator">:</span>                                 <span class="c1"># Name and value of additional arguments which will be included in every recording test file</span>
  <span class="l l-Scalar l-Scalar-Plain">robot</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">burger</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">waffle.yaml</span></code></li>
</ul>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">path_length</span><span class="p p-Indicator">:</span>                                          <span class="c1"># Topics for the metric &#39;path_length&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">topics</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;/tf&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">wait_for_topics</span><span class="p p-Indicator">:</span>                                      <span class="c1"># Names of the topics to wait for before beginning the test</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;/odom&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">wait_for_services</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span>                                 <span class="c1"># Names of the services to wait for before beginning the test</span>
<span class="l l-Scalar l-Scalar-Plain">additional_parameters</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span>                             <span class="c1"># Name and value of additional parameter which will be included in every recording test file</span>
<span class="l l-Scalar l-Scalar-Plain">additional_arguments</span><span class="p p-Indicator">:</span>                                 <span class="c1"># Name and value of additional arguments which will be included in every recording test file</span>
  <span class="l l-Scalar l-Scalar-Plain">robot</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">waffle</span>
</pre></div>
</div>
</div>
<div class="section" id="robot-environments">
<span id="robot-environments"></span><h3>2.4.2. Robot environments<a class="headerlink" href="#robot-environments" title="Permalink to this headline">¶</a></h3>
<p>We only want to test the application in one environment. Thus, add the following files into the <code class="docutils literal"><span class="pre">config/robot_envs</span></code> folder.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">env1.yaml</span></code></li>
</ul>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">additional_parameters</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{}</span>                                <span class="c1"># Name and value of additional parameter which will be included in every recording test file</span>
<span class="l l-Scalar l-Scalar-Plain">additional_arguments</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{}</span>                                 <span class="c1"># Name and value of additional arguments which will be included in every recording test file</span>
</pre></div>
</div>
</div>
<div class="section" id="tests">
<span id="tests"></span><h3>2.4.3. Tests<a class="headerlink" href="#tests" title="Permalink to this headline">¶</a></h3>
<p>This section is dedicated to define the desired key performance indicators. As such, there are common metrics available to measure e.g. duration, distance and frequency. Further individual ones can be created by the developer.
In the navigation use-case, we want to use ATF to benchmark the application regarding the execution duration and the traveled path length.</p>
<p>We will also use this configuration to preset our desired goal poses for the navigation task.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Alternatively, one could also set desired goal poses as arguments one each in a file of the <em>robot_envs</em> folder. The reason to define them in the test folder is that we want to have one dedicated groundtruth value per goal request and don&#8217;t want to cross-test them.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The ground truth value is not required for benchmarking, but for the case you want to do CI (Continuous Integration).</p>
</div>
<p>Thus, the following files have to be added into the <code class="docutils literal"><span class="pre">config/test_configs</span></code> folder.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">test1.yaml</span></code></li>
</ul>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">move_to_goal</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">time</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span>

  <span class="l l-Scalar l-Scalar-Plain">goal2d</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">x</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0.5</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">y</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">-0.2</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">yaw</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0.0</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">test2.yaml</span></code></li>
</ul>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">move_to_goal</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">time</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span>

  <span class="l l-Scalar l-Scalar-Plain">goal2d</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">x</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">-0.5</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">y</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">-0.2</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">yaw</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0.0</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Be aware that package requires a dependency to <em>atf_core</em> and in the <cite>CMakeList.txt</cite> the function call to <em>atf_test()</em></p>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="run_atf_tests.html" class="btn btn-neutral float-right" title="3. Run ATF tests" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="prepare_workspace.html" class="btn btn-neutral" title="1. Prepare workspace" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Jonathan Hechtbauer.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>